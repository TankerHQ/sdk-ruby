default:
  before_script: &global_before_script
  - poetry install

stages:
  - check
  - deploy

##########
# Stages #
##########

.check:
  stage: check

.deploy:
  stage: deploy

#############################
# Default settings override #
#############################

.before-script/download-artifacts:
  before_script:
    - *global_before_script
    - poetry run python run-ci.py reset-branch $UPSTREAM_BRANCH_NAME
    - poetry install
    - poetry run python run-ci.py download-artifacts --project-id=$UPSTREAM_PROJECT_ID --pipeline-id=$UPSTREAM_PIPELINE_ID --job-name=$UPSTREAM_JOB_NAME

.before-script/rbenv-path:
  before_script:
    - *global_before_script
    - export PATH=$HOME/.rbenv/versions/$RBENV_VERSION/bin:$PATH

.before-script/rbenv-path-download-artifacts:
  before_script:
    - *global_before_script
    - export PATH=$HOME/.rbenv/versions/$RBENV_VERSION/bin:$PATH
    - poetry run python run-ci.py reset-branch $UPSTREAM_BRANCH_NAME
    - poetry run python run-ci.py download-artifacts --project-id=$UPSTREAM_PROJECT_ID --pipeline-id=$UPSTREAM_PIPELINE_ID --job-name=$UPSTREAM_JOB_NAME

########
# Tags #
########

.tags/linux:
  tags:
    - linux

.tags/macos:
  tags:
    - macos

##############
# Conditions #
##############

.if-valid-ruby-release-version: &if-valid-ruby-release-version
    if: $SDK_RUBY_RELEASE_VERSION =~ /\A([0-9]+)\.([0-9]+)\.([0-9]+)(\.(alpha|beta)\.[0-9]+)?\z/

.if-invalid-ruby-release-version: &if-invalid-ruby-release-version
    if: $SDK_RUBY_RELEASE_VERSION !~ /\A([0-9]+)\.([0-9]+)\.([0-9]+)(\.(alpha|beta)\.[0-9]+)?\z/

.if-invalid-native-conan-reference: &if-invalid-native-conan-reference
    if: $SDK_NATIVE_LATEST_CONAN_REFERENCE !~ /\Atanker\/([0-9]+)\.([0-9]+)\.([0-9]+)+(-(alpha|beta)+[0-9]+)?@([a-z]+\/[a-z]+)?\z/

.if-upstream-release-deploy-stage: &if-upstream-release-deploy-stage
    if: $CI_PIPELINE_SOURCE == "pipeline" && $SDK_RUBY_RELEASE_VERSION =~ /\A([0-9]+)\.([0-9]+)\.([0-9]+)(\.(alpha|beta)\.[0-9]+)?\z/ && $UPSTREAM_BRIDGE_STAGE == "deploy"

.if-invalid-web-release: &if-invalid-web-release
    if: $CI_PIPELINE_SOURCE == "web" && $SDK_RUBY_RELEASE_VERSION !~ /\A([0-9]+)\.([0-9]+)\.([0-9]+)(\.(alpha|beta)\.[0-9]+)?\z/

.if-merge-result: &if-merge-result
    if: $CI_MERGE_REQUEST_ID == null && $CI_PIPELINE_SOURCE == "push" && ($CI_COMMIT_REF_NAME == "master" || $CI_COMMIT_REF_NAME =~ /\Afeat\/.+\z/)

.if-upstream-ci-pipeline: &if-upstream-ci-pipeline
    if: $CI_PIPELINE_SOURCE == "pipeline" && $UPSTREAM_BRIDGE_STAGE != "deploy"

.if-web-pipeline: &if-web-pipeline
    if: $CI_PIPELINE_SOURCE == "web"

.if-mr-pipeline: &if-mr-pipeline
    if: $CI_PIPELINE_SOURCE == "merge_request_event"

.if-schedule-pipeline: &if-schedule-pipeline
    if: $CI_PIPELINE_SOURCE == "schedule"

.if-not-push-pipeline: &if-not-push-pipeline
    if: $CI_PIPELINE_SOURCE != "push"

.if-ref-master: &if-ref-master
    if: $CI_COMMIT_REF_NAME == "master"

.if-release-tag: &if-release-tag
    if: $CI_COMMIT_REF_NAME =~ /\Av[0-9.]+\z/

.if-release-branch: &if-release-branch
    if: $CI_COMMIT_REF_NAME =~ /\Arelease\/.*\z/

.if-feature-branch: &if-feature-branch
    if: $CI_COMMIT_REF_NAME =~ /\Afeat\/.+\z/

.if-not-linux-upstream-job: &if-not-linux-upstream-job
    if: $CI_PIPELINE_SOURCE == "pipeline" && $UPSTREAM_RUNNER_TAG != "linux"

.if-not-macos-upstream-job: &if-not-macos-upstream-job
    if: $CI_PIPELINE_SOURCE == "pipeline" && $UPSTREAM_RUNNER_TAG != "macos"

#########
# Rules #
#########

.rules/mr/auto:
  rules:
    - <<: *if-mr-pipeline

.rules/deployed-native:
  rules:
    - <<: *if-web-pipeline
    - <<: *if-mr-pipeline
      when: manual
      allow_failure: true

.rules/native-from-sources:
  rules:
    - <<: *if-mr-pipeline
      when: manual
      allow_failure: true
    - <<: *if-merge-result
    - <<: *if-schedule-pipeline

.rules/check/downstream/linux:
  rules:
    - <<: *if-not-linux-upstream-job
      when: never
    - <<: *if-upstream-ci-pipeline

.rules/check/downstream/macos:
  rules:
    - <<: *if-not-macos-upstream-job
      when: never
    - <<: *if-upstream-ci-pipeline

.rules/check/downstream/release:
  rules:
    - <<: *if-upstream-release-deploy-stage

.rules/deploy:
  rules:
    - <<: *if-invalid-ruby-release-version
      when: never
    - <<: *if-web-pipeline
      when: manual
    - <<: *if-upstream-release-deploy-stage

.rules/pages:
  rules:
    - <<: *if-merge-result

.rules/mirror:
  rules:
    - <<: *if-not-push-pipeline
      when: never
    - <<: *if-ref-master
    - <<: *if-release-tag
    - <<: *if-release-branch
    - <<: *if-feature-branch

##################
# Workflow rules #
##################

workflow:
  rules:
    # web pipelines for releases only
    - <<: *if-invalid-web-release
      when: never
    - <<: *if-invalid-native-conan-reference
      when: never
    # allow everything else
    - when: always

#################
# Extend blocks #
#################

.release-artifacts:
  artifacts:
    paths:
      - vendor/libctanker

.check/native-from-sources/linux:
  extends:
    - .check
    - .tags/linux
    - .rules/native-from-sources
    - .before-script/rbenv-path
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=same-as-branch --profile gcc8-release-shared

.check/downstream/linux:
  extends:
    - .check
    - .tags/linux
    - .rules/check/downstream/linux
    - .before-script/rbenv-path-download-artifacts
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=upstream --profile gcc8-release-shared

.check/downstream/release/linux:
  extends:
    - .check
    - .tags/linux
    - .rules/check/downstream/release
    - .before-script/rbenv-path
    - .release-artifacts
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --profile gcc8-release-shared

###############
# check stage #
###############

lint:
  extends:
    - .check
    - .tags/linux
    - .rules/mr/auto
    - .before-script/rbenv-path
  variables:
    RBENV_VERSION: 2.7.1
  script:
    - poetry run python run-ci.py lint

check/native-from-sources/linux/2.6:
  extends:
    - .check
    - .tags/linux
    - .check/native-from-sources/linux
  variables:
    RBENV_VERSION: 2.6.6

check/native-from-sources/linux/2.7:
  extends:
    - .check
    - .tags/linux
    - .check/native-from-sources/linux
  variables:
    RBENV_VERSION: 2.7.1

check/deployed-native/linux/2.6:
  extends:
    - .check
    - .tags/linux
    - .before-script/rbenv-path
    - .rules/deployed-native
    - .release-artifacts
  variables:
    RBENV_VERSION: 2.6.6
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --profile gcc8-release-shared

check/deployed-native/linux/2.7:
  extends:
    - .check
    - .tags/linux
    - .before-script/rbenv-path
    - .rules/deployed-native
    - .release-artifacts
  variables:
    RBENV_VERSION: 2.7.1
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --profile gcc8-release-shared

check/native-from-sources/macos/2.7:
  extends:
    - .check
    - .tags/macos
    - .rules/native-from-sources
  variables:
    RBENV_VERSION: 2.7.1
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=same-as-branch --profile macos-release-shared

check/deployed-native/macos/2.7:
  extends:
    - .check
    - .tags/macos
    - .rules/deployed-native
    - .release-artifacts
  variables:
    RBENV_VERSION: 2.7.1
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --profile macos-release-shared

check/downstream/linux/2.6:
  extends:
    - .check/downstream/linux
  variables:
    RBENV_VERSION: 2.6.6

check/downstream/linux/2.7:
  extends:
    - .check/downstream/linux
  variables:
    RBENV_VERSION: 2.7.1

check/downstream/macos/2.7:
  extends:
    - .check
    - .tags/macos
    - .rules/check/downstream/macos
    - .before-script/download-artifacts
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=upstream --profile macos-release-shared
  variables:
    RBENV_VERSION: 2.7.1

check/downstream/release/linux/2.6:
  extends:
    - .check/downstream/release/linux
  variables:
    RBENV_VERSION: 2.6.6

check/downstream/release/linux/2.7:
  extends:
    - .check/downstream/release/linux
  variables:
    RBENV_VERSION: 2.7.1

check/downstream/release/macos/2.7:
  extends:
    - .check
    - .tags/macos
    - .rules/check/downstream/release
    - .release-artifacts
  script:
    - poetry run python run-ci.py --isolate-conan-user-home build-and-test --use-tanker=deployed --profile macos-release-shared
  variables:
    RBENV_VERSION: 2.7.1

################
# deploy stage #
################

deploy:
  extends:
    - .deploy
    - .tags/linux
    - .rules/deploy
    - .before-script/rbenv-path
  script:
    - poetry run python run-ci.py deploy --version $SDK_RUBY_RELEASE_VERSION
  variables:
    RBENV_VERSION: 2.6.6
  release:
    description: sdk-python v$SDK_RUBY_RELEASE_VERSION
    tag_name: v$SDK_RUBY_RELEASE_VERSION

mirror:
  extends:
    - .deploy
    - .tags/linux
    - .rules/mirror
  script:
    - poetry run python run-ci.py mirror
